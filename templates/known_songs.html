{% extends 'base.html' %}
{% block content %}

<div class="container py-4">
    <div class="card shadow-lg border-0 rounded-4 mb-4 bg-dark bg-opacity-75">
        <div class="card-header border-0 text-white py-3 rounded-top-4">
            <h2 class="h4 mb-0 text-center">Song Checker</h2>
        </div>

        <div class="card-body p-4">
            <div class="text-center mb-4">
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary me-2" onclick="generateNewSong()">Get Song</button>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <div class="card bg-dark bg-opacity-50 border-0 rounded-3 transition-fade">
                        <div class="card-body position-relative">
                            <div id="loadingSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="lyrics" class="fs-5 text-center py-3 text-light opacity-transition"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="song-attributes mt-4">
                <div class="attribute-group mb-3">
                    <h5 class="text-light text-center">Is this a Sunday song?</h5>
                    <div class="d-flex justify-content-center gap-3">
                        <input type="checkbox" class="btn-check" id="sunday-yes" autocomplete="off">
                        <label class="btn btn-outline-light" for="sunday-yes">Yes</label>

                        <input type="checkbox" class="btn-check" id="sunday-no" autocomplete="off">
                        <label class="btn btn-outline-light" for="sunday-no">No</label>
                    </div>
                </div>

                <!-- Holiday/Event Song Check -->
                <div class="attribute-group mb-3">
                    <h5 class="text-light text-center">Is this an Event/Holiday song?</h5>
                    <div class="d-flex justify-content-center gap-3">
                        <input type="checkbox" class="btn-check" id="holiday-yes" autocomplete="off">
                        <label class="btn btn-outline-light" for="holiday-yes">Yes</label>

                        <input type="checkbox" class="btn-check" id="holiday-no" autocomplete="off">
                        <label class="btn btn-outline-light" for="holiday-no">No</label>
                    </div>
                </div>

                <!-- Weekday Song Check -->
                <div class="attribute-group mb-3">
                    <h5 class="text-light text-center">Is this a Weekday song?</h5>
                    <div class="d-flex justify-content-center gap-3">
                        <input type="checkbox" class="btn-check" id="weekday-yes" autocomplete="off">
                        <label class="btn btn-outline-light" for="weekday-yes">Yes</label>

                        <input type="checkbox" class="btn-check" id="weekday-no" autocomplete="off">
                        <label class="btn btn-outline-light" for="weekday-no">No</label>
                    </div>
                </div>

                <!-- Choir Knowledge Check -->
                <div class="attribute-group mb-3">
                    <h5 class="text-light text-center">Does the choir know this song?</h5>
                    <div class="d-flex justify-content-center">
                        <button id="choirKnowledgeBtn" class="btn btn-primary" onclick="submitChoirKnowledge()">
                            Mark as Known by Choir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Add mutual exclusivity within each group
    function setupMutualExclusion(yesId, noId) {
        const yesCheckbox = document.getElementById(yesId);
        const noCheckbox = document.getElementById(noId);

        yesCheckbox.addEventListener('change', () => {
            if (yesCheckbox.checked) noCheckbox.checked = false;
        });

        noCheckbox.addEventListener('change', () => {
            if (noCheckbox.checked) yesCheckbox.checked = false;
        });
    }

    // Setup all groups
    setupMutualExclusion('sunday-yes', 'sunday-no');
    setupMutualExclusion('holiday-yes', 'holiday-no');
    setupMutualExclusion('weekday-yes', 'weekday-no');
</script>
<script>
    let currentSongData = {
        isSunday: null,
        isHoliday: null,
        isWeekday: null,
        choirKnows: false
    };

    function setSundayStatus(status) {
        currentSongData.isSunday = status;
        updateButtonStates('sunday', status);
    }

    function setHolidayStatus(status) {
        currentSongData.isHoliday = status;
        updateButtonStates('holiday', status);
    }

    function setWeekdayStatus(status) {
        currentSongData.isWeekday = status;
        updateButtonStates('weekday', status);
    }

    function updateButtonStates(type, status) {
        const group = document.querySelector(`.attribute-group:nth-child(${type === 'sunday' ? 1 : type === 'holiday' ? 2 : 3
            })`);
        const buttons = group.querySelectorAll('button');

        buttons.forEach((btn, index) => {
            btn.classList.remove('btn-outline-light', 'btn-light');
            if ((index === 0 && status) || (index === 1 && !status)) {
                btn.classList.add('btn-light');
            } else {
                btn.classList.add('btn-outline-light');
            }
        });
    }

    function submitChoirKnowledge() {
        const songId = /* Get current song ID from your application state */;

        fetch('/api/choir-knowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                songId: songId,
                isSunday: currentSongData.isSunday,
                isHoliday: currentSongData.isHoliday,
                isWeekday: currentSongData.isWeekday,
                choirKnows: true
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = document.getElementById('choirKnowledgeBtn');
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    btn.textContent = 'Song Marked as Known';
                    btn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update choir knowledge status');
            });
    }

    function generateNewSong() {
        // Reset all states
        currentSongData = {
            isSunday: null,
            isHoliday: null,
            isWeekday: null,
            choirKnows: false
        };

        // Reset button states
        document.querySelectorAll('.attribute-group button').forEach(btn => {
            btn.classList.remove('btn-light');
            btn.classList.add('btn-outline-light');
        });

        const choirBtn = document.getElementById('choirKnowledgeBtn');
        choirBtn.classList.remove('btn-success');
        choirBtn.classList.add('btn-primary');
        choirBtn.textContent = 'Mark as Known by Choir';
        choirBtn.disabled = false;

        // Your existing generate new song logic here
    }
</script>

{% endblock %}